# MT-v6.141fix3 修改说明

## 修改概述

基于MT-v6.141_fixsleepbug版本，实现短时间每日休眠逻辑，避免产生过夜费，同时添加未来24小时交易事件显示功能。

## 主要修改内容

### 1. 短时间每日休眠逻辑

**修改的休眠时间：**
- 每日收盘前：从30分钟改为20分钟
- 每日开盘后：从30分钟改为10分钟

**休眠时长计算修复：**
- 每日收盘前：休眠到收盘时间（20分钟），而不是次日开盘后30分钟
- 每日开盘后：休眠10分钟，而不是30分钟

### 2. 休眠逻辑保持原版特性

**休眠时的行为：**
- ✅ 当前轮继续交易
- ✅ 继续计算加仓间隔
- ✅ 继续计算目标保证金盈利率
- ✅ 继续执行加仓交易
- ✅ 达到目标后平仓
- ✅ 平仓后不再开始新一轮交易

### 3. 新增24小时交易事件显示

**显示内容：**
- 每日收盘前20分钟休眠
- 每日开盘后10分钟休眠结束
- 亚洲盘开盘前15分钟休眠
- 欧洲盘开盘前15分钟休眠
- 美国盘开盘前15分钟休眠
- 周五收盘休眠

## 修改的代码位置

### 1. 休眠时间参数修改
```cpp
input int      BeforeCloseMinutes = 20;           // 收盘前禁止开单(分钟)
input int      AfterOpenMinutes = 10;             // 开盘后禁止开单(分钟)
```

### 2. CalculateSleepEndTime函数修改
```cpp
// 每日收盘前 - 休眠到收盘时间（短时间休眠避免过夜费）
if(StringFind(reason, "每日收盘") >= 0)
{
   // 计算收盘时间
   MqlDateTime closeDt = dt;
   closeDt.hour = DailyCloseHour;
   closeDt.min = DailyCloseMin;
   closeDt.sec = 0;
   
   datetime closeTime = StructToTime(closeDt);
   if(closeTime <= currentTime)
      closeTime += 24 * 3600;  // 如果已过收盘时间，计算明天收盘时间
   
   return closeTime;
}

// 每日开盘后 - 休眠到开盘后10分钟结束（短时间休眠）
if(StringFind(reason, "每日开盘后") >= 0)
{
   // 直接返回当前时间 + 10分钟
   return currentTime + AfterOpenMinutes * 60;
}
```

### 3. 新增24小时交易事件显示功能
```cpp
// 新增全局变量
string next24hEvents = "";       // 未来24小时交易事件

// 新增函数
void CalculateNext24hEvents()
{
   // 计算未来24小时内的所有交易事件
   // 包括每日休眠、市场盘切换、周五收盘等
}

// 在OnTick中调用
CalculateNext24hEvents();

// 在图表显示中添加
if(next24hEvents != "")
{
   displayText += "\n--- 📅 未来24小时交易事件 ---\n";
   displayText += next24hEvents;
}
```

## 修改效果对比

### 休眠时间对比

| 休眠场景 | 原版v6.141fix | 修改版v6.141fix3 |
|---------|---------------|------------------|
| 每日收盘前 | 休眠25小时 | 休眠20分钟 |
| 每日开盘后 | 休眠30分钟 | 休眠10分钟 |
| 周五收盘 | 休眠2天30分钟 | 休眠2天30分钟 |
| 周末 | 休眠1-2天30分钟 | 休眠1-2天30分钟 |

### 每日休眠时间计算

**原版问题：**
- 04:30触发 → 休眠到次日06:30（26小时）
- 总休眠时间：约25小时

**修改后：**
- 04:40触发 → 休眠到05:00（20分钟）
- 06:10触发 → 休眠到06:20（10分钟）
- 总休眠时间：每天30分钟

### 新增功能

**24小时交易事件显示：**
```
--- 📅 未来24小时交易事件 ---
04:40 每日收盘前20分钟休眠
05:00 每日开盘后10分钟休眠结束
07:45 亚洲盘开盘前15分钟休眠
14:45 欧洲盘开盘前15分钟休眠
20:15 美国盘开盘前15分钟休眠
22:00 周五收盘休眠
```

## 技术细节

### 1. 休眠状态机

```
正常交易
    │
    ├─► 每日收盘前20分钟 → 休眠20分钟 → 恢复交易
    ├─► 每日开盘后10分钟 → 休眠10分钟 → 恢复交易
    ├─► 周五22:00 → 休眠到下周一06:30
    └─► 市场盘切换 → 休眠15分钟 → 恢复交易
```

### 2. 关键变量

```cpp
// 休眠时间参数
int BeforeCloseMinutes = 20;     // 收盘前20分钟
int AfterOpenMinutes = 10;       // 开盘后10分钟

// 24小时事件显示
string next24hEvents = "";       // 未来24小时交易事件
```

### 3. 执行流程

```
OnTick()
  │
  ├─► 检查休眠状态
  ├─► 计算下次休眠时间
  ├─► 计算24小时交易事件
  ├─► 执行交易逻辑
  └─► 更新图表显示
```

## 使用建议

### 1. 参数设置

**推荐设置：**
```
EnableMarketTimeControl = true   // 启用市场时间控制
BeforeCloseMinutes = 20          // 收盘前20分钟
AfterOpenMinutes = 10            // 开盘后10分钟
```

### 2. 监控要点

**正常行为：**
- 每日04:40-05:00：休眠20分钟（避免过夜费）
- 每日06:10-06:20：休眠10分钟（避免开盘波动）
- 其他时间：正常交易

**异常情况：**
- 如果休眠时间过长，检查时间参数设置
- 如果24小时事件显示异常，检查时区设置

### 3. 日志监控

**关键日志：**
- `每日收盘前20分钟,禁止开单`
- `每日开盘后10分钟,禁止开单`
- `休眠时当前轮继续交易`
- `达到目标后平仓不再开新单`

## 测试验证

### 1. 必测场景

- [ ] 每日04:40进入休眠，05:00自动恢复
- [ ] 每日06:10进入休眠，06:20自动恢复
- [ ] 休眠时当前轮继续交易
- [ ] 休眠时达到目标后平仓
- [ ] 平仓后不再开新单
- [ ] 24小时事件显示正确

### 2. 压力测试

- [ ] 连续运行一周，观察休眠行为
- [ ] 验证过夜费是否避免
- [ ] 检查24小时事件显示准确性
- [ ] 测试手动休眠/唤醒功能

## 兼容性

### 1. 向下兼容

- ✅ 所有原版参数保留
- ✅ 所有原版功能保留
- ✅ 日志格式兼容
- ✅ 按钮功能保留
- ✅ 图表显示向下兼容

### 2. 配置迁移

从v6.141fix迁移到v6.141fix3：
1. 直接替换EA文件
2. 无需修改任何参数
3. 自动应用新的休眠逻辑

## 总结

本次修改成功实现了：

1. ✅ **短时间每日休眠** - 避免过夜费，每天仅休眠30分钟
2. ✅ **保持原版休眠逻辑** - 当前轮继续交易，达到目标后平仓
3. ✅ **修复休眠时长计算** - 从25小时减少到30分钟
4. ✅ **新增24小时事件显示** - 提前了解未来交易事件
5. ✅ **向下兼容** - 保持所有原版功能

修改后的EA既能避免过夜费，又能最大化交易时间，同时提供详细的未来交易事件预览。

---

**修改完成时间**: 2025年10月22日  
**修改版本**: v6.141fix3  
**基于版本**: v6.141fix  
**修改者**: AI Assistant






