# MT-v6.141_fixsleepbug - 修复休眠Bug版本

## 版本信息
- **版本号**: v6.141fix
- **基于版本**: MT-v6.141
- **修复日期**: 2025年10月

## 核心修复内容

### 问题描述
原版本MT-v6.141的休眠逻辑存在以下问题：
1. 到达休眠时间后，不再下新订单
2. 已下的订单也不立即平仓
3. 程序处于"干耗"状态，既不交易也不平仓

### 用户需求
到达休眠时间时：
1. **当前轮交易继续正常执行**
   - 正常计算加仓间隔
   - 正常计算盈利率目标
   - 触发条件正常下单加仓
   
2. **当前轮完成后不再开新轮**
   - 当前轮达到盈利目标后平仓
   - 平仓后不再开始新一轮交易
   - 直到休眠时间结束或手动唤醒

3. **休眠期间实时计算继续**
   - 波动率计算等实时工作
   - 不影响技术指标计算

4. **图表显示增强**
   - 显示接下来什么时候因什么原因进入休眠（预警）
   - 休眠时显示休眠状态和原因
   - 显示接下来什么时候将进入什么盘的交易

## 主要修改点

### 1. OnTick函数核心逻辑修改
```cpp
// 原逻辑：休眠时直接return，不执行任何交易
if(isSleeping) return;

// 新逻辑：休眠时如果有持仓，继续执行策略
if(isSleeping && totalOrders == 0) return;
// 如果有持仓，继续执行后续逻辑
```

### 2. 马丁和对冲逻辑修改
```cpp
// 原逻辑：休眠状态下不进行加仓
if(martingaleEnabled && firstOrderOpened && totalOrders > 0 && !isSleeping)
{
    ExecuteStrategy();
}

// 新逻辑：休眠状态下也允许加仓（让当前轮完成）
if(martingaleEnabled && firstOrderOpened && totalOrders > 0)
{
    ExecuteStrategy();  // 休眠时也执行
}
```

### 3. 平仓后逻辑修改
```cpp
// 新增：休眠状态下达到盈利目标后不再开新单
if(isSleeping)
{
    WriteLog("休眠状态下达到盈利目标，已平仓");
    WriteLog("【重要】保持休眠状态，不再开始新一轮交易");
    firstOrderOpened = false;
    // 保持休眠状态，等待时间结束或手动唤醒
}
```

### 4. 新增预警功能
- 新增 `CalculateNextSleepTime()` 函数
- 计算下次休眠时间和原因
- 在图表上提前60分钟预警

### 5. 图表显示增强
- 显示当前市场盘（亚洲盘/欧洲盘/美洲盘）
- 显示下次交易盘切换时间
- 休眠时显示"当前轮继续交易中"状态
- 显示休眠预警倒计时

## 使用方法

### 1. 安装
将 `AdvancedMartingale_EA_v6.141_fixsleepbug.mq5` 复制到MT5的专家顾问目录：
```
MT5安装目录/MQL5/Experts/
```

### 2. 编译
在MT5的MetaEditor中打开文件并编译（F7）

### 3. 使用
在MT5图表上拖入EA，设置参数后启动

### 4. 观察休眠行为
1. 到达休眠时间点时
2. 观察图表显示"【当前轮继续交易中】"
3. EA继续计算加仓间隔和执行加仓
4. 达到盈利目标后平仓
5. 保持休眠状态，不再开新单

## 测试建议

### 场景1：休眠前有持仓
1. 在休眠时间前开仓
2. 等待到达休眠时间
3. 观察是否继续加仓
4. 观察达到目标后是否平仓且不再开新单

### 场景2：休眠时无持仓
1. 确保休眠时无持仓
2. 观察是否不开新单
3. 等待休眠结束
4. 观察是否恢复交易

### 场景3：手动休眠
1. 点击"休眠"按钮
2. 观察当前轮是否继续
3. 点击"唤醒"按钮
4. 观察是否立即恢复交易

## 技术特性保留

所有原版MT-v6.141的特性完全保留：
- ✅ 优化动态加仓间隔
- ✅ 三级优先级系统
- ✅ 修正盈利率递减
- ✅ 时间风险控制
- ✅ 黄金市场时间节点控制
- ✅ 极端行情检测
- ✅ 多维度趋势判断
- ✅ 四因子盈利目标

## 新增特性

- ✅ **休眠时当前轮继续交易**
- ✅ **达到目标后不再开新单**
- ✅ **休眠预警功能（60分钟提前预警）**
- ✅ **交易盘信息显示**
- ✅ **增强的图表状态显示**

## 注意事项

1. **休眠逻辑**: 休眠只影响开新的第一单，不影响当前轮的加仓和平仓
2. **波动率计算**: 休眠期间所有技术指标继续实时计算
3. **手动唤醒**: 手动休眠需要手动唤醒才能恢复交易
4. **自动唤醒**: 时间触发的休眠会在设定时间后自动恢复

## 日志说明

修改后的日志会明确记录：
- `【重要】当前轮交易将继续正常执行（计算加仓间隔、盈利率目标、执行加仓）`
- `【重要】当前轮达到盈利目标平仓后，将不再开始新一轮交易`
- `休眠状态下达到盈利目标，已平仓`
- `【重要】保持休眠状态，不再开始新一轮交易`

## 对比原版

| 功能 | 原版v6.141 | 修复版v6.141fix |
|------|------------|-----------------|
| 休眠时有持仓 | 停止所有交易逻辑 | 继续执行当前轮 |
| 休眠时加仓 | 不允许 | 允许（当前轮） |
| 休眠后平仓 | 需手动平仓 | 自动达到目标平仓 |
| 平仓后开单 | 可能自动开单 | 休眠期不开新单 |
| 休眠预警 | 无 | 60分钟提前预警 |
| 盘次显示 | 仅显示当前盘 | 显示当前盘和下次盘 |
| 休眠状态显示 | 简单显示 | 详细显示+倒计时 |

## 支持

如有问题，请查看：
- 📖 [修复说明.md](修复说明.md) - 详细修复说明
- 📖 [快速开始.txt](快速开始.txt) - 快速入门指南

## 版本历史

- **v6.141fix** (2025-10)
  - 修复休眠时不继续当前轮交易的Bug
  - 新增休眠预警功能
  - 增强图表显示
  - 新增交易盘信息显示

- **v6.141** (原版)
  - 优化动态间隔
  - 三级优先级系统
  - 修正盈利率递减



